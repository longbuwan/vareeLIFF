<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #0288d1 0%, #01579b 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      padding: 10px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      padding: 20px 0;
    }

    #profile {
      text-align: center;
      margin-bottom: 20px;
      color: white;
    }

    #profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-bottom: 8px;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .header h1 {
      margin: 10px 0;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .header p {
      margin: 8px 0 0 0;
      opacity: 0.9;
      font-size: 1rem;
    }

    .progress-bar {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
    }

    .progress-fill {
      background: white;
      height: 8px;
      border-radius: 6px;
      transition: width 0.3s ease;
      width: 33%;
    }

    .progress-text {
      text-align: center;
      color: white;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    .selection-card {
      background: white;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
      animation: fadeInUp 0.5s ease-out;
    }

    .card-header {
      background: linear-gradient(135deg, #0288d1, #0277bd);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header.green {
      background: linear-gradient(135deg, #4caf50, #388e3c);
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-number {
      background: rgba(255,255,255,0.2);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .card-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #01579b;
      font-size: 0.95rem;
    }

    .search-input, .score-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e3f2fd;
      border-radius: 12px;
      font-size: 1rem;
      margin-bottom: 8px;
      background: #f8faff;
      transition: all 0.3s ease;
    }

    .score-input {
      max-width: 150px;
    }

    .search-input:focus, .score-input:focus {
      outline: none;
      border-color: #0288d1;
      background: white;
    }

    .custom-dropdown {
      width: 100%;
      max-height: 200px;
      border: 2px solid #e3f2fd;
      border-radius: 12px;
      background: white;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .dropdown-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
      font-size: 0.95rem;
    }

    .dropdown-option:hover {
      background-color: #f8faff;
    }

    .dropdown-option.selected {
      background-color: #e3f2fd;
      color: #01579b;
      font-weight: 600;
    }

    .dropdown-option:last-child {
      border-bottom: none;
    }

    .loading-option {
      color: #666;
      font-style: italic;
      text-align: center;
      cursor: default;
    }

    .loading-option:hover {
      background-color: white;
    }

    .selection-summary {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      color: #01579b;
    }

    .summary-item {
      margin: 6px 0;
      line-height: 1.5;
    }

    .summary-label {
      font-weight: 600;
    }

    .navigation-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 48px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0288d1, #01579b);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(2, 136, 209, 0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(255,255,255,0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .btn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .results-container {
      display: none;
    }

    .results-container.active {
      display: block;
    }

    .program-info {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .program-info h3 {
      color: #01579b;
      font-size: 1.4rem;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .program-info p {
      color: #0277bd;
      font-size: 1rem;
      line-height: 1.8;
      margin: 8px 0;
    }

    .program-info strong {
      font-weight: 600;
    }

    .test-list {
      display: grid;
      gap: 15px;
    }

    .test-item {
      background: white;
      border: 2px solid #e3f2fd;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .test-item:hover {
      border-color: #0288d1;
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(2, 136, 209, 0.2);
    }

    .test-name {
      font-weight: 600;
      color: #01579b;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .test-weight {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .test-link-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #0288d1, #01579b);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .test-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(2, 136, 209, 0.4);
    }

    .score-input-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .score-input-row label {
      flex: 1;
      margin: 0;
    }

    .results-table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }

    .results-table th,
    .results-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e3f2fd;
    }

    .results-table th {
      background: #f8faff;
      color: #01579b;
      font-weight: 600;
    }

    .results-table .good {
      color: #4caf50;
      font-weight: 600;
    }

    .results-table .bad {
      color: #f44336;
      font-weight: 600;
    }

    .btn-restart {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 14px 35px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
      margin: 20px auto 0;
    }

    .btn-restart:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 5px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .card-body {
        padding: 16px;
      }
      
      .custom-dropdown {
        max-height: 150px;
      }
      
      .btn {
        font-size: 0.95rem;
        padding: 12px;
      }

      .program-info {
        padding: 20px;
      }

      .program-info h3 {
        font-size: 1.2rem;
      }

      .score-input-row {
        flex-direction: column;
        align-items: stretch;
      }

      .score-input {
        max-width: 100%;
      }

      .results-table {
        font-size: 0.9rem;
      }

      .results-table th,
      .results-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="profile">
        <img id="picture" src="" alt="Profile Picture">
        <h2 id="name">Loading...</h2>
      </div>
      <h1>üéì ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ</p>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</div>

    <!-- Step 1: Select University -->
    <div class="selection-card" id="card1">
      <div class="card-header">
        <h3>üèõÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</h3>
        <div class="card-number">1</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="searchUniversity">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</label>
          <input type="text" class="search-input" id="searchUniversity" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
          <div class="custom-dropdown" id="universityDropdown">
            <div class="dropdown-option loading-option">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢...</div>
          </div>
        </div>

        <div class="selection-summary" id="universitySummary" style="display: none;">
          <div class="summary-item">
            <span class="summary-label">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span> <span id="selectedUniversity">-</span>
          </div>
        </div>

        <div class="navigation-buttons">
          <button class="btn btn-primary" id="nextBtn1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Step 2: Select Faculty -->
    <div class="selection-card" id="card2" style="display: none;">
      <div class="card-header">
        <h3>üè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞</h3>
        <div class="card-number">2</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="searchFaculty">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ì‡∏∞:</label>
          <input type="text" class="search-input" id="searchFaculty" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
          <div class="custom-dropdown" id="facultyDropdown">
            <div class="dropdown-option loading-option">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Å‡πà‡∏≠‡∏ô</div>
          </div>
        </div>

        <div class="selection-summary" id="facultySummary" style="display: none;">
          <div class="summary-item">
            <span class="summary-label">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</span> <span id="summaryUni2">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span> <span id="selectedFaculty">-</span>
          </div>
        </div>

        <div class="navigation-buttons">
          <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
          <button class="btn btn-primary" id="nextBtn2" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Select Program -->
    <div class="selection-card" id="card3" style="display: none;">
      <div class="card-header">
        <h3>üìö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</h3>
        <div class="card-number">3</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="searchProgram">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£:</label>
          <input type="text" class="search-input" id="searchProgram" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
          <div class="custom-dropdown" id="programDropdown">
            <div class="dropdown-option loading-option">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞‡∏Å‡πà‡∏≠‡∏ô</div>
          </div>
        </div>

        <div class="selection-summary" id="programSummary" style="display: none;">
          <div class="summary-item">
            <span class="summary-label">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</span> <span id="summaryUni3">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">‡∏Ñ‡∏ì‡∏∞:</span> <span id="summaryFac3">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</span> <span id="selectedProgram">-</span>
          </div>
        </div>

        <div class="navigation-buttons">
          <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
          <button class="btn btn-primary" id="showTestsBtn" disabled>‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="resultsContainer">
      <div class="program-info" id="programInfo"></div>
      
      <div class="selection-card">
        <div class="card-header">
          <h3>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h3>
        </div>
        <div class="card-body">
          <div class="test-list" id="testList"></div>
          <div class="navigation-buttons">
            <button class="btn btn-primary" onclick="showScoreInput()">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Score Input Section -->
    <div class="results-container" id="scoreInputContainer">
      <div class="program-info" id="programInfo2"></div>
      
      <div class="selection-card">
        <div class="card-header green">
          <h3>‚úçÔ∏è ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</h3>
        </div>
        <div class="card-body">
          <div id="scoreInputList"></div>

          <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="backToTests()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <button class="btn btn-success" onclick="calculateScores()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculation Results -->
    <div class="results-container" id="calculationContainer">
      <div class="program-info" id="programInfo3"></div>
      
      <div class="selection-card">
        <div class="card-header green">
          <h3>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
        </div>
        <div class="card-body">
          <div id="calculationResults"></div>
          <div class="navigation-buttons">
            <button class="btn btn-secondary" onclick="backToScoreInput()">‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="btn btn-restart" onclick="restart()">üîÑ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data structure with weights for each program
    const data = {
      
      universities: [
        {
          id: 'mahidol',
          name: '‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏°‡∏´‡∏¥‡∏î‡∏•',
          faculties: [
            {
              id: 'medicine_rama',
              name: '‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏≤‡∏°‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ',
              programs: [
                {
                  id: 'speech_disorder',
                  name: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢',
                  fullName: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏Ç‡∏ï ‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤',
                  targetScore: 55.75,
                  tests: [
                    { name: 'TGAT', fullName: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (TGAT)', link: 'https://www.mytcas.com/', weight: 0.25 },
                    { name: 'A-Level apmath', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå 1', link: 'https://www.classtime.com/code/FKEE9K', weight: 0.1125 },
                    { name: 'A-Level phys', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå', link: 'https://www.classtime.com/code/2FSUFF', weight: 0.1125 },
                    { name: 'A-Level chem', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ', link: 'https://www.classtime.com/code/XXYSTT', weight: 0.075 },
                    { name: 'A-Level bio', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', link: 'https://www.classtime.com/code/TTPF2Q', weight: 0.1125 },
                    { name: 'A-Level soc', fullName: 'A-Level ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', link: 'https://www.classtime.com/code/SVFC65', weight: 0.075 },
                    { name: 'A-Level th', fullName: 'A-Level ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', link: 'https://www.classtime.com/code/4AH9N9', weight: 0.1125 },
                    { name: 'A-Level eng', fullName: 'A-Level ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', link: 'https://www.classtime.com/code/JKJSA3', weight: 0.15 }
                  ]
                }
              ]
            },
            {
              id: 'engineering',
              name: '‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
              programs: [
                {
                  id: 'chemical_eng',
                  name: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏Ñ‡∏°‡∏µ',
                  fullName: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏Ç‡∏ï ‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤',
                  targetScore: 50.6,
                  tests: [
                    { name: 'TPAT3', fullName: 'TPAT3 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', link: 'https://www.mytcas.com/', weight: 0.30 },
                    { name: 'A-Level apmath', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå 1', link: 'https://www.classtime.com/code/FKEE9K', weight: 0.20 },
                    { name: 'A-Level phys', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå', link: 'https://www.classtime.com/code/2FSUFF', weight: 0.20 },
                    { name: 'A-Level chem', fullName: 'A-Level ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ', link: 'https://www.classtime.com/code/XXYSTT', weight: 0.20 },
                    { name: 'A-Level eng', fullName: 'A-Level ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', link: 'https://www.classtime.com/code/JKJSA3', weight: 0.10 }
                  ]
                }
              ]
            },
            {
              id: 'liberal_arts',
              name: '‡∏Ñ‡∏ì‡∏∞‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
              programs: [
                {
                  id: 'thai_lang',
                  name: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢',
                  fullName: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ‡∏Å‡∏ï‡∏¥) ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÄ‡∏Ç‡∏ï ‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤',
                  targetScore: 73.05,
                  tests: [
                    { name: 'GPAX', fullName: 'GPAX', link: 'https://reg.mfu.ac.th/backend/api/files/media_library/CAL_ENG_2022-09-07%2013:41:38.011693.pdf', weight: 0.20 },
                    { name: 'A-Level soc', fullName: 'A-Level ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', link: 'https://www.classtime.com/code/SVFC65', weight: 0.20 },
                    { name: 'A-Level th', fullName: 'A-Level ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', link: 'https://www.classtime.com/code/4AH9N9', weight: 0.40 },
                    { name: 'A-Level eng', fullName: 'A-Level ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', link: 'https://www.classtime.com/code/JKJSA3', weight: 0.20 }
                  ]
                }
              ]
            }
          ]
        }
      ]
    };

    // State management
    let selectedUniversity = null;
    let selectedFaculty = null;
    let selectedProgram = null;
    let currentStep = 1;
    let allUniversities = [];
    let currentFaculties = [];
    let currentPrograms = [];
    let userScores = {};

    // Initialize
    window.onload = async function () {
      populateUniversities();
      setupEventListeners();
      
      try {
        await liff.init({ liffId: "2007611527-z7ZNLXOk" });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          document.getElementById("name").innerText = profile.displayName;
          document.getElementById("picture").src = profile.pictureUrl;
        } else {
          liff.login();
        }
      } catch (error) {
        console.log('LIFF initialization error:', error);
      }
    };

    function setupEventListeners() {
      document.getElementById('searchUniversity').addEventListener('input', filterUniversities);
      document.getElementById('searchFaculty').addEventListener('input', filterFaculties);
      document.getElementById('searchProgram').addEventListener('input', filterPrograms);
      
      document.getElementById('nextBtn1').addEventListener('click', () => goToStep(2));
      document.getElementById('nextBtn2').addEventListener('click', () => goToStep(3));
      document.getElementById('showTestsBtn').addEventListener('click', showTests);
    }

    function populateUniversities() {
      allUniversities = data.universities.map(u => ({ id: u.id, name: u.name, data: u }));
      renderUniversityDropdown(allUniversities);
    }

    function renderUniversityDropdown(universities) {
      const dropdown = document.getElementById('universityDropdown');
      dropdown.innerHTML = '';
      
      if (universities.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-option loading-option">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</div>';
        return;
      }
      
      universities.forEach(uni => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.textContent = uni.name;
        option.onclick = () => selectUniversity(uni);
        dropdown.appendChild(option);
      });
    }

    function renderFacultyDropdown(faculties) {
      const dropdown = document.getElementById('facultyDropdown');
      dropdown.innerHTML = '';
      
      if (faculties.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-option loading-option">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ì‡∏∞</div>';
        return;
      }
      
      faculties.forEach(fac => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.textContent = fac.name;
        option.onclick = () => selectFaculty(fac);
        dropdown.appendChild(option);
      });
    }

    function renderProgramDropdown(programs) {
      const dropdown = document.getElementById('programDropdown');
      dropdown.innerHTML = '';
      
      if (programs.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-option loading-option">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</div>';
        return;
      }
      
      programs.forEach(prog => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.textContent = prog.name;
        option.onclick = () => selectProgram(prog);
        dropdown.appendChild(option);
      });
    }

    function selectUniversity(uni) {
      selectedUniversity = uni;
      document.getElementById('searchUniversity').value = uni.name;
      document.getElementById('selectedUniversity').textContent = uni.name;
      document.getElementById('universitySummary').style.display = 'block';
      document.getElementById('nextBtn1').disabled = false;
      
      highlightSelected('universityDropdown', uni.name);
      
      currentFaculties = uni.data.faculties || [];
    }

    function selectFaculty(fac) {
      selectedFaculty = fac;
      document.getElementById('searchFaculty').value = fac.name;
      document.getElementById('selectedFaculty').textContent = fac.name;
      document.getElementById('summaryUni2').textContent = selectedUniversity.name;
      document.getElementById('facultySummary').style.display = 'block';
      document.getElementById('nextBtn2').disabled = false;
      
      highlightSelected('facultyDropdown', fac.name);
      
      currentPrograms = fac.programs || [];
    }

    function selectProgram(prog) {
      selectedProgram = prog;
      document.getElementById('searchProgram').value = prog.name;
      document.getElementById('selectedProgram').textContent = prog.name;
      document.getElementById('summaryUni3').textContent = selectedUniversity.name;
      document.getElementById('summaryFac3').textContent = selectedFaculty.name;
      document.getElementById('programSummary').style.display = 'block';
      document.getElementById('showTestsBtn').disabled = false;
      
      highlightSelected('programDropdown', prog.name);
    }

    function highlightSelected(dropdownId, text) {
      const dropdown = document.getElementById(dropdownId);
      const options = dropdown.querySelectorAll('.dropdown-option');
      options.forEach(opt => {
        opt.classList.remove('selected');
        if (opt.textContent === text) {
          opt.classList.add('selected');
        }
      });
    }

    function filterUniversities() {
      const search = document.getElementById('searchUniversity').value.toLowerCase();
      const filtered = allUniversities.filter(u => u.name.toLowerCase().includes(search));
      renderUniversityDropdown(filtered);
    }

    function filterFaculties() {
      const search = document.getElementById('searchFaculty').value.toLowerCase();
      const filtered = currentFaculties.filter(f => f.name.toLowerCase().includes(search));
      renderFacultyDropdown(filtered);
    }

    function filterPrograms() {
      const search = document.getElementById('searchProgram').value.toLowerCase();
      const filtered = currentPrograms.filter(p => p.name.toLowerCase().includes(search));
      renderProgramDropdown(filtered);
    }

    function goToStep(step) {
      document.getElementById('card1').style.display = 'none';
      document.getElementById('card2').style.display = 'none';
      document.getElementById('card3').style.display = 'none';
      
      document.getElementById(`card${step}`).style.display = 'block';
      currentStep = step;
      
      const progress = (step / 3) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      const stepTexts = {
        1: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢',
        2: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞',
        3: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'
      };
      document.getElementById('progressText').textContent = stepTexts[step];
      
      if (step === 2 && currentFaculties.length > 0) {
        renderFacultyDropdown(currentFaculties);
      }
      if (step === 3 && currentPrograms.length > 0) {
        renderProgramDropdown(currentPrograms);
      }
    }

    function showTests() {
      document.getElementById('card1').style.display = 'none';
      document.getElementById('card2').style.display = 'none';
      document.getElementById('card3').style.display = 'none';
      
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('progressText').textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';
      
      const programInfoHtml = `
        <h3>üìö ${selectedProgram.name}</h3>
        <p><strong>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</strong> ${selectedUniversity.name}</p>
        <p><strong>‡∏Ñ‡∏ì‡∏∞:</strong> ${selectedFaculty.name}</p>
        <p><strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏ï‡πá‡∏°:</strong> ${selectedProgram.fullName}</p>
        <p><strong>üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${selectedProgram.targetScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
      `;
      
      document.getElementById('programInfo').innerHTML = programInfoHtml;
      
      const testList = document.getElementById('testList');
      testList.innerHTML = '';
      selectedProgram.tests.forEach(test => {
        const testItem = document.createElement('div');
        testItem.className = 'test-item';
        testItem.innerHTML = `
          <div class="test-name">${test.fullName}</div>
          <div class="test-weight">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${(test.weight * 100).toFixed(0)}%</div>
          <a href="${test.link}" target="_blank" class="test-link-btn">
            <span>üìù</span>
            <span>‡πÑ‡∏õ‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</span>
          </a>
        `;
        testList.appendChild(testItem);
      });
      
      document.getElementById('resultsContainer').classList.add('active');
    }

    function showScoreInput() {
      document.getElementById('resultsContainer').classList.remove('active');
      
      const programInfoHtml = `
        <h3>üìö ${selectedProgram.name}</h3>
        <p><strong>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</strong> ${selectedUniversity.name}</p>
        <p><strong>‡∏Ñ‡∏ì‡∏∞:</strong> ${selectedFaculty.name}</p>
        <p><strong>üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${selectedProgram.targetScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
      `;
      
      document.getElementById('programInfo2').innerHTML = programInfoHtml;
      
      const scoreInputList = document.getElementById('scoreInputList');
      scoreInputList.innerHTML = '';
      
      selectedProgram.tests.forEach((test, index) => {
        const inputRow = document.createElement('div');
        inputRow.className = 'score-input-row';
        inputRow.innerHTML = `
          <label>${test.fullName}:</label>
          <input type="number" class="score-input" id="score_${index}" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" min="0" max="100">
        `;
        scoreInputList.appendChild(inputRow);
      });
      
      document.getElementById('scoreInputContainer').classList.add('active');
    }

    function backToTests() {
      document.getElementById('scoreInputContainer').classList.remove('active');
      document.getElementById('resultsContainer').classList.add('active');
    }

    function backToScoreInput() {
      document.getElementById('calculationContainer').classList.remove('active');
      document.getElementById('scoreInputContainer').classList.add('active');
    }

    function calculateScores() {
      // Get user scores
      userScores = {};
      let allFilled = true;
      
      selectedProgram.tests.forEach((test, index) => {
        const scoreInput = document.getElementById(`score_${index}`);
        const score = parseFloat(scoreInput.value);
        
        if (isNaN(score) || score < 0) {
          allFilled = false;
        } else {
          userScores[test.name] = score;
        }
      });
      
      // Use pre-defined target score from program
      const targetScore = selectedProgram.targetScore;
      
      if (!allFilled) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
        return;
      }
      
      // Calculate weighted target scores
      const weights = {};
      selectedProgram.tests.forEach(test => {
        weights[test.name] = test.weight;
      });
      
      const targetScores = weightedTargetScores(weights, targetScore);
      
      // Display results
      showCalculationResults(userScores, targetScores, targetScore);
    }

    function weightedTargetScores(weights, target) {
      // Convert weights if they sum to 100
      let totalW = Object.values(weights).reduce((sum, w) => sum + w, 0);
      if (totalW > 1.01) {
        const newWeights = {};
        for (let key in weights) {
          newWeights[key] = weights[key] / 100;
        }
        weights = newWeights;
      }
      
      // Calculate k
      const sumW2 = Object.values(weights).reduce((sum, w) => sum + w * w, 0);
      const k = target / sumW2;
      
      // Compute scores
      const scores = {};
      for (let subject in weights) {
        scores[subject] = k * weights[subject];
      }
      
      return scores;
    }

    function showCalculationResults(userScores, targetScores, targetTotal) {
      document.getElementById('scoreInputContainer').classList.remove('active');
      
      const programInfoHtml = `
        <h3>üìö ${selectedProgram.name}</h3>
        <p><strong>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢:</strong> ${selectedUniversity.name}</p>
        <p><strong>‡∏Ñ‡∏ì‡∏∞:</strong> ${selectedFaculty.name}</p>
        <p><strong>üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</strong> ${targetTotal.toFixed(2)}</p>
      `;
      
      document.getElementById('programInfo3').innerHTML = programInfoHtml;
      
      // Calculate weighted total for user scores
      const actualTotal = selectedProgram.tests.reduce((sum, test) => {
        return sum + (userScores[test.name] * test.weight);
      }, 0);
      const targetTotalCalc = Object.values(targetScores).reduce((sum, score) => sum + score, 0);
      
      let tableHtml = `
        <table class="results-table">
          <thead>
            <tr>
              <th>‡∏ß‡∏¥‡∏ä‡∏≤</th>
              <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
              <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ</th>
              <th>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      selectedProgram.tests.forEach(test => {
        const userScore = userScores[test.name];
        const targetScore = targetScores[test.name];
        const diff = userScore - targetScore;
        const diffClass = diff >= 0 ? 'good' : 'bad';
        const diffSymbol = diff >= 0 ? '+' : '';
        
        tableHtml += `
          <tr>
            <td>${test.fullName}</td>
            <td>${(test.weight * 100).toFixed(0)}%</td>
            <td>${userScore.toFixed(2)}</td>
            <td>${targetScore.toFixed(2)}</td>
            <td class="${diffClass}">${diffSymbol}${diff.toFixed(2)}</td>
          </tr>
        `;
      });
      
      const totalDiff = actualTotal - targetTotal;
      const totalDiffClass = totalDiff >= 0 ? 'good' : 'bad';
      const totalDiffSymbol = totalDiff >= 0 ? '+' : '';
      
      tableHtml += `
          <tr style="font-weight: 600; background: #f8faff;">
            <td>‡∏£‡∏ß‡∏°</td>
            <td>100%</td>
            <td>${actualTotal.toFixed(2)}</td>
            <td>${targetTotal.toFixed(2)}</td>
            <td class="${totalDiffClass}">${totalDiffSymbol}${totalDiff.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>
      `;
      
      if (totalDiff >= 0) {
        tableHtml += `
          <div class="selection-summary" style="margin-top: 20px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
            <div style="font-size: 1.1rem; font-weight: 600; color: #2e7d32;">
              ‚úÖ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${Math.abs(totalDiff).toFixed(2)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </div>
          </div>
        `;
      } else {
        tableHtml += `
          <div class="selection-summary" style="margin-top: 20px; background: linear-gradient(135deg, #ffebee, #ffcdd2);">
            <div style="font-size: 1.1rem; font-weight: 600; color: #c62828;">
              ‚ö†Ô∏è ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${Math.abs(totalDiff).toFixed(2)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </div>
            <div style="margin-top: 10px; color: #d32f2f;">
              ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
            </div>
          </div>
        `;
      }
      
      document.getElementById('calculationResults').innerHTML = tableHtml;
      document.getElementById('calculationContainer').classList.add('active');
    }

    function restart() {
      selectedUniversity = null;
      selectedFaculty = null;
      selectedProgram = null;
      currentFaculties = [];
      currentPrograms = [];
      userScores = {};
      
      document.getElementById('searchUniversity').value = '';
      document.getElementById('searchFaculty').value = '';
      document.getElementById('searchProgram').value = '';
      
      document.getElementById('universitySummary').style.display = 'none';
      document.getElementById('facultySummary').style.display = 'none';
      document.getElementById('programSummary').style.display = 'none';
      
      document.getElementById('nextBtn1').disabled = true;
      document.getElementById('nextBtn2').disabled = true;
      document.getElementById('showTestsBtn').disabled = true;
      
      document.getElementById('resultsContainer').classList.remove('active');
      document.getElementById('scoreInputContainer').classList.remove('active');
      document.getElementById('calculationContainer').classList.remove('active');
      
      populateUniversities();
      goToStep(1);
    }
  </script>
</body>
</html>
